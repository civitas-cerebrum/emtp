name: EMTP Pipeline

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-run:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner in repo mode
      uses: aquasecurity/trivy-action@0.28.0
      with:
        scan-type: 'fs'
        ignore-unfixed: true
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL, HIGH'

    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install -r requirements.txt

    - name: Install Semgrep CLI
      run: python3 -m pip install semgrep

    - name: Run Semgrep SAST and Secrets Scanning
      run: semgrep scan --sarif --sarif-output=semgrep.sarif

    - name: Upload Semgrep scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'semgrep.sarif'


    - name: Generate config.ini with secrets
      run: |
        # Export secrets as environment variables
        export BASE_URL="${{ secrets.BASE_URL }}"
        export MODEL="${{ secrets.MODEL }}"
        export AUTH_TOKEN="${{ secrets.AUTH_TOKEN }}"
        export DATASET_PROMPT="${{ vars.DATASET_PROMPT }}"
        export FIRECRAWL_URL="${{ secrets.FIRECRAWL_URL }}"
        export FIRECRAWL_USER="${{ secrets.FIRECRAWL_USER }}"
        export FIRECRAWL_PASS="${{ secrets.FIRECRAWL_PASS }}"

        cat > config.ini << EOF
        [DEFAULT]
        model_expertise = Quality Assurance
        input_dir = dataset/acquisition/temp/datasources
        base_url = ${BASE_URL}
        model_name = ${MODEL}
        authorization_token = ${AUTH_TOKEN}
        dataset_prompt = ${DATASET_PROMPT}
        firecrawl_url = ${FIRECRAWL_URL}
        firecrawl_user = ${FIRECRAWL_USER}
        firecrawl_pass = ${FIRECRAWL_PASS}
        EOF

        echo "Generated config.ini:"
        cat config.ini

    - name: Run EMTP Pipeline
      run: python main.py --stage full_pipeline --questions-file dataset/acquisition/retrieve_url/sample.json --verbose